<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftLink - URL Shortener</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* --- Base & Typography --- */
        body {
            font-family: 'Inter', sans-serif;
            color: #e0e0e0;
            transition: background 0.5s ease-in-out;
        }

        /* --- Theme 1: Login & Register (Gradient Glassmorphism) --- */
        body.auth-theme {
             background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        }
        .auth-container {
            margin: 5rem auto;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            max-width: 450px;
        }
        .auth-container h2 {
            font-weight: 300;
            color: #fff;
        }
        .auth-container .form-control {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        .auth-container .form-control::placeholder { color: #ccc; }
        .auth-container .btn-primary {
            background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
            border: none;
            color: #1a237e;
            font-weight: 500;
        }
        .auth-container a { color: #d1c4e9; }

        /* --- Theme 2: Dashboard (Deep Space) --- */
        body.dashboard-theme {
            background-color: #0d1117;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.1) 1px, transparent 0);
            background-size: 20px 20px;
        }
        .dashboard-container {
            max-width: 1000px;
            margin: 3rem auto;
            padding: 40px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 16px;
        }
        .dashboard-container h2, .dashboard-container h4 {
            font-weight: 500;
            color: #c9d1d9;
        }
        .dashboard-container .form-control {
            background-color: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
        }
        .dashboard-container .btn-primary {
            background: #238636;
            border-color: #2ea043;
            color: #fff;
        }
        .dashboard-container .btn-primary:hover {
            background: #2ea043;
        }
        .table {
            --bs-table-bg: transparent;
            --bs-table-striped-bg: #161b22;
            --bs-table-hover-bg: #1f242c;
            color: #c9d1d9;
            border-color: #30363d;
        }
        .table a { color: #58a6ff; }
        .table a:hover { color: #80bfff; }
        /* --- THIS IS THE FIX --- */
        .dashboard-container .table th {
            color:#e0e0e0;
        }
        /* --- THIS IS THE NEW STYLE FOR THE CLICKS COUNT --- */
        .clicks-cell {
            color: #2ea043 !important; /* Use the theme's green color */
            font-weight: 700;
            font-size: 1.1rem;
            text-align: center;
        }
        .clicks-header {
            text-align: center;
        }
        td { word-break: break-all; }
        .btn, .form-control { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .hidden { display: none; }
    </style>
</head>
<body class="auth-theme">

<div class="container">
    <!-- Message Container -->
    <div id="message-container" class="alert hidden" role="alert" style="max-width: 800px; margin: 20px auto 0;"></div>

    <!-- Login Page -->
    <div id="loginPage" class="auth-container">
        <h2 class="text-center mb-4">Welcome to SwiftLink</h2>
        <form id="loginForm">
            <div class="mb-3">
                <label for="loginUsername" class="form-label">Username</label>
                <input type="text" class="form-control" id="loginUsername" required>
            </div>
            <div class="mb-3">
                <label for="loginPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-primary w-100 mt-3 py-2">Login</button>
        </form>
        <p class="text-center mt-3">Don't have an account? <a href="#" id="showRegister">Register here</a></p>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="auth-container hidden">
        <h2 class="text-center mb-4">Create Account</h2>
        <form id="registerForm">
            <div class="mb-3">
                <label for="registerUsername" class="form-label">Username</label>
                <input type="text" class="form-control" id="registerUsername" required>
            </div>
            <div class="mb-3">
                <label for="registerEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="registerEmail" required>
            </div>
            <div class="mb-3">
                <label for="registerPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="registerPassword" required>
            </div>
            <button type="submit" class="btn btn-primary w-100 mt-3 py-2">Register</button>
        </form>
        <p class="text-center mt-3">Already have an account? <a href="#" id="showLogin">Login here</a></p>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="dashboard-container hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 id="welcomeMessage">Dashboard</h2>
            <button id="logoutButton" class="btn btn-outline-danger">Logout</button>
        </div>

        <form id="shortenUrlForm" class="mb-4">
            <div class="input-group">
                <input type="url" class="form-control py-2" id="originalUrl" placeholder="Enter a long URL to shorten..." required>
                <button type="submit" class="btn btn-primary px-4">Shorten</button>
            </div>
        </form>

        <h4 class="mt-5">My Links</h4>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                <tr>
                    <th>Original URL</th>
                    <th>Short URL</th>
                    <th>Clicks</th>
                </tr>
                </thead>
                <tbody id="urlList">
                <!-- Links will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const loginPage = document.getElementById('loginPage');
    const registerPage = document.getElementById('registerPage');
    const dashboardPage = document.getElementById('dashboardPage');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const shortenUrlForm = document.getElementById('shortenUrlForm');
    const showRegister = document.getElementById('showRegister');
    const showLogin = document.getElementById('showLogin');
    const logoutButton = document.getElementById('logoutButton');
    const urlList = document.getElementById('urlList');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const messageContainer = document.getElementById('message-container');

    function showPage(page) {
        loginPage.classList.add('hidden');
        registerPage.classList.add('hidden');
        dashboardPage.classList.add('hidden');
        page.classList.remove('hidden');
    }

    function showMessage(message, isError = true) {
        messageContainer.textContent = message;
        messageContainer.classList.remove('hidden', 'alert-danger', 'alert-success');
        messageContainer.classList.add(isError ? 'alert-danger' : 'alert-success');
    }

    function hideMessage() {
        messageContainer.classList.add('hidden');
    }

    showRegister.addEventListener('click', (e) => {
        e.preventDefault();
        showPage(registerPage);
    });

    showLogin.addEventListener('click', (e) => {
        e.preventDefault();
        showPage(loginPage);
    });

    logoutButton.addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        showPage(loginPage);
        urlList.innerHTML = ''; // Clear the table
    });

    // --- LOGIN ---
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            if (!response.ok) throw new Error('Invalid credentials');

            const data = await response.json();

            // --- FIX: Log the response to debug and correctly access the JWT token
            console.log('Login response:', data);

            // The token is likely in data.jwt based on AuthResponse
            // Try multiple possible field names to be safe
            const token = data.jwt || data.token || data.accessToken;

            if (!token) {
                console.error('No token found in response:', data);
                throw new Error('No token received from server');
            }

            localStorage.setItem('token', token);
            localStorage.setItem('username', username);

            // Log to confirm token is stored
            console.log('Token stored successfully');

            updateDashboard();
            showPage(dashboardPage);
        } catch (error) {
            alert('Login failed: ' + error.message);
            console.error('Login error:', error);
        }
    });

    // --- REGISTER ---
    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('registerUsername').value;
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;

        try {
            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email, password })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Registration failed');
            }

            alert('Registration successful! Please login.');
            showPage(loginPage);
        } catch (error) {
            alert('Registration failed: ' + error.message);
        }
    });

    // --- FETCH USER URLS ---
    async function fetchUserUrls() {
        const token = localStorage.getItem('token');
        if (!token) {
            console.error('No token found, redirecting to login');
            showPage(loginPage);
            return;
        }

        try {
            const response = await fetch('/api/urls/my-urls', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.status === 401 || response.status === 403) {
                // Handle token expiration or invalid token
                console.error('Token expired or invalid');
                logoutButton.click();
                return;
            }
            if (!response.ok) throw new Error('Could not fetch links.');

            const urls = await response.json();
            urlList.innerHTML = ''; // Clear existing list
            urls.forEach(url => {
                const fullShortUrl = `http://${window.location.host}/${url.shortUrl}`;
                const row = `
                    <tr>
                        <td><a href="${url.originalUrl}" target="_blank">${url.originalUrl}</a></td>
                        <td><a href="${fullShortUrl}" target="_blank">${fullShortUrl}</a></td>
                        <td class="clicks-cell">${url.clickCount}</td>
                    </tr>
                `;
                urlList.innerHTML += row;
            });
        } catch (error) {
            showMessage('Failed to fetch link details.');
            console.error('Fetch URLs error:', error);
        }
    }

    // --- SHORTEN URL ---
    shortenUrlForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const originalUrl = document.getElementById('originalUrl').value;
        const token = localStorage.getItem('token');

        if (!token) {
            console.error('No token found, redirecting to login');
            showPage(loginPage);
            return;
        }

        try {
            const response = await fetch('/api/urls/shorten', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ originalUrl })
            });

            if (response.status === 401 || response.status === 403) {
                // Handle token expiration
                console.error('Token expired or invalid');
                logoutButton.click();
                return;
            }

            if (!response.ok) throw new Error('Failed to shorten URL.');

            // Success
            hideMessage();
            document.getElementById('originalUrl').value = ''; // Clear input
            fetchUserUrls(); // Refresh the list
        } catch (error) {
            showMessage('Failed to shorten the link.');
            console.error('Shorten URL error:', error);
        }
    });

    function updateDashboard() {
        const username = localStorage.getItem('username');
        if (username) {
            welcomeMessage.textContent = `Welcome, ${username}`;
            fetchUserUrls();
        }
    }

    // Check if user is already logged in on page load
    window.addEventListener('load', () => {
        const token = localStorage.getItem('token');
        if (token) {
            updateDashboard();
            showPage(dashboardPage);
        } else {
            showPage(loginPage);
        }
    });

</script>
</body>
</html>